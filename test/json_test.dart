import 'dart:convert';

import 'package:boring_flutter/src/article.dart';
import 'package:test/test.dart';
import 'package:http/http.dart' as http;

void main() {
  test('parses topstories.json', () {
    final String jsonString = '[18105129,18102578,18104879,18104867,18105026,18102923,18103717,18098925,18098924,18098899,18103949,18103640,18101820,18097569,18102885,18101141,18103835,18098689,18081632,18098501,18104508,18099304,18103162,18099596,18103417,18104167,18100967,18104794,18100536,18102260,18100807,18091968,18099305,18101689,18103159,18099926,18099145,18099265,18100243,18097977,18104761,18105099,18097487,18104439,18104400,18099226,18081978,18100526,18100156,18099262,18098992,18104326,18089552,18099029,18099581,18099127,18102273,18097433,18101292,18105046,18098490,18099673,18100895,18102287,18100490,18098057,18100674,18098715,18098413,18099561,18103566,18094285,18079863,18094823,18097661,18102055,18104068,18082017,18099835,18101570,18086418,18102871,18094328,18095246,18099877,18103565,18083931,18098829,18103137,18093069,18093302,18100447,18098830,18090651,18098589,18102586,18099484,18097325,18096070,18100273,18100253,18095224,18102949,18102905,18087637,18098639,18098046,18099582,18097439,18104501,18104329,18096809,18095333,18097584,18103157,18082684,18104405,18099331,18083641,18083576,18098197,18101090,18098955,18092653,18092932,18098196,18100522,18097105,18096511,18092711,18095356,18096517,18094435,18093158,18098714,18103271,18091119,18091778,18090189,18091655,18093465,18085765,18096264,18091489,18096685,18083344,18098658,18098239,18078640,18090991,18083506,18102719,18091690,18083509,18096339,18101130,18103785,18102713,18081212,18091478,18093355,18102323,18087208,18088099,18101232,18086820,18085640,18101180,18100738,18087443,18103654,18084013,18083793,18096251,18083824,18084309,18098844,18092117,18087657,18101702,18103502,18082465,18091736,18087610,18086084,18100799,18077960,18092748,18093568,18096337,18084399,18084388,18088028,18092837,18081279,18100396,18078135,18081821,18079479,18090221,18081920,18090674,18104005,18083207,18088293,18101565,18092271,18095538,18094555,18077907,18083790,18095579,18094782,18095730,18082345,18083755,18094560,18083583,18086529,18103908,18098439,18099832,18077316,18097722,18085062,18084994,18090954,18094734,18077612,18087638,18079855,18083508,18083373,18098870,18092055,18103069,18086552,18099570,18091820,18093472,18102317,18087509,18092967,18088951,18087514,18077780,18082759,18102110,18078239,18099700,18101279,18077446,18098527,18077049,18082332,18086767,18092652,18078184,18086042,18084634,18086009,18099483,18099027,18099026,18085140,18082604,18086031,18080795,18100475,18103156,18088210,18080390,18091558,18092906,18088836,18101045,18080706,18094836,18081477,18077674,18077312,18100189,18091372,18086135,18101752,18093981,18076994,18097039,18082295,18090937,18082384,18076993,18082931,18101572,18096241,18077203,18078878,18085669,18093097,18101270,18082795,18079134,18079522,18096513,18080800,18097442,18097402,18097926,18077336,18100381,18087266,18081921,18095864,18087289,18082201,18079148,18100898,18090850,18098304,18083149,18086764,18081537,18080789,18100637,18082033,18101829,18085353,18090472,18085997,18095756,18096475,18087417,18100128,18077766,18083505,18097225,18083307,18084054,18077005,18098738,18079748,18083596,18086321,18077750,18080874,18078030,18092991,18098543,18092827,18077746,18092680,18078972,18096772,18079526,18080181,18092376,18087413,18089686,18091929,18089474,18078742,18092492,18078491,18087398,18098746,18079574,18088320,18086747,18097360,18086159,18096523,18093197,18079071,18091234,18083817,18097093,18098112,18081163,18092930,18077434,18089825,18080729,18092660,18096665,18090517,18085864,18103664,18099356,18084970,18086860,18095326,18093973,18092922,18080798,18096549,18079003,18087304,18098858,18078892,18077908,18097345,18080291,18095266,18082102,18085578,18100093,18083620,18081527,18078061,18097059,18092417,18080716,18098478,18087723,18080608,18090218,18079543,18083105,18078393,18089539,18079044,18095505,18076811,18086658,18097959,18082285,18084109,18094756,18087481,18089450,18080180,18089180,18080283,18097256,18092083,18097108,18094350,18093807,18080598,18084046,18078963,18090868,18092260,18089037,18090802,18078624,18093605,18083173,18095279,18086950,18082061,18076931,18087275,18079933,18085728,18085528,18083859,18093628,18084434,18090384,18092249,18087515,18078712,18081199,18080995,18088688,18079641,18079485,18080999,18081271,18091027,18090807,18079571,18079944,18080864,18085746,18093193,18079297,18085397,18085073,18080242,18083828,18083332,18089509,18089490,18089135,18093623,18089044,18080742,18096617,18080404,18093003,18087930,18079919,18082486,18081940,18085365,18085284,18090590,18080184]';
    
    expect(parseTopStories(jsonString).first, 18105129);
  });

  test('parses item.json', () {
    final String jsonString = '{"by":"dhouston","descendants":71,"id":8863,"kids":[9224,8952,8917,8884,8887,8869,8940,8908,8958,9005,8873,9671,9067,9055,8865,8881,8872,8955,10403,8903,8928,9125,8998,8901,8902,8907,8894,8870,8878,8980,8934,8943,8876],"score":104,"time":1175714200,"title":"My YC app: Dropbox - Throw away your USB drive","type":"story","url":"http://www.getdropbox.com/u/2/screencast.html"}';

    expect(parseArticle(jsonString).by, 'dhouston');
  });

  test('parses item.json over a network', () async {
    final String url = 'https://hacker-news.firebaseio.com/v0/beststories.json';
    final http.Response res = await http.get(url);

    expect(res.statusCode, 200);
    expect(parseTopStories(res.body), isNotEmpty);

    final List idList = (json.decode(res.body) as List);
    final String storyUrl = 'https://hacker-news.firebaseio.com/v0/item/${idList.first}.json';
    final http.Response storyRes = await http.get(storyUrl);

    expect(storyRes.statusCode, 200);
    expect(parseArticle(storyRes.body).id, isNotNull);
  });
}
